<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mantra Player</title>
    
    <!-- Mobile App Capabilities -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">

    <!-- Dynamic Manifest Link will be injected here by JS -->
    <link id="dynamic-manifest" rel="manifest" href="">

    <style>
        :root {
            --primary: #ff0055;
            --primary-glow: #ff005580;
            --bg-dark: #0f0f13;
            --bg-panel: rgba(255, 255, 255, 0.05);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f13 100%);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header & Visualizer --- */
        header { padding: 15px; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        
        h1 { font-size: 1rem; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }

        .visualizer-container {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-panel);
            border-radius: 12px;
            border: var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        canvas { width: 100%; height: 100%; }

        /* --- Install Button --- */
        #installContainer { display: none; } 
        #installBtn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.3s;
        }
        #installBtn:hover { background: var(--primary); color: white; }

        /* --- Main Player Area --- */
        main { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 20px; overflow-y: auto; }

        .track-info { text-align: center; margin-bottom: 20px; }
        .track-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-status { font-size: 0.9rem; color: var(--primary); min-height: 1.2em; font-weight: bold; }

        /* --- Progress Bar --- */
        .progress-container { width: 100%; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .time-label { font-size: 0.8rem; color: var(--text-muted); min-width: 40px; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--primary-glow); }

        /* --- Controls --- */
        .controls-row { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; }
        .btn { background: none; border: none; color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-main { width: 70px; height: 70px; border-radius: 50%; background: var(--bg-panel); border: var(--glass-border); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-main svg { width: 28px; height: 28px; fill: var(--primary); }
        .btn-small svg { width: 24px; height: 24px; fill: var(--text-muted); }

        /* --- Repeat Counter Feature --- */
        .repeat-feature {
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between; border: var(--glass-border);
        }
        .repeat-controls { display: flex; align-items: center; gap: 10px; }
        .repeat-input {
            width: 60px; background: rgba(255,255,255,0.1); border: none; color: white; padding: 5px;
            border-radius: 4px; text-align: center; font-size: 1rem; -moz-appearance: textfield;
        }
        .repeat-input::-webkit-outer-spin-button, .repeat-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .repeat-toggle { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; cursor: pointer; background: #333; color: #aaa; border: none; }
        .repeat-toggle.active { background: var(--primary); color: white; box-shadow: 0 0 10px var(--primary-glow); }

        /* --- Playlist --- */
        .playlist-section { flex-grow: 1; background: var(--bg-panel); border-radius: 16px 16px 0 0; padding: 20px; border-top: var(--glass-border); display: flex; flex-direction: column; }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .file-btn { background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; border: none; cursor: pointer; box-shadow: 0 4px 10px var(--primary-glow); font-weight: 600; }
        .playlist { list-style: none; overflow-y: auto; flex-grow: 1; }
        .track-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; border-radius: 8px; }
        .track-item:hover { background: rgba(255,255,255,0.05); }
        .track-item.active { background: rgba(255, 0, 85, 0.15); border-left: 3px solid var(--primary); }
        .track-item-name { font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; }
        .remove-track { color: #ff4444; background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0 5px; }

        footer { text-align: center; padding: 10px; font-size: 0.75rem; color: #555; background: #0a0a0c; }
        
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95); color: white; padding: 12px 24px;
            border-radius: 25px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 1000; border: 1px solid #333; text-align: center; width: max-content; max-width: 80%;
        }
        #toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <h1>Mantra Player</h1>
        <div id="installContainer">
            <button id="installBtn">Install App</button>
        </div>
    </header>

    <main>
        <div class="visualizer-container">
            <canvas id="visualizer"></canvas>
        </div>
        <br>

        <div class="track-info">
            <div class="track-title" id="currentTitle">No Track Selected</div>
            <div class="track-status" id="trackStatus">Ready to play</div>
        </div>

        <div class="progress-container">
            <span class="time-label" id="currentTime">0:00</span>
            <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
            <span class="time-label" id="duration">0:00</span>
        </div>

        <div class="controls-row">
            <button class="btn btn-small" id="btnPrev" title="Previous">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>
            
            <button class="btn btn-main" id="btnPlayPause" title="Play/Pause">
                <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            
            <button class="btn btn-small" id="btnNext" title="Next">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
        </div>

        <div class="controls-row" style="margin-bottom: 20px;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#777"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            <input type="range" id="volumeBar" min="0" max="1" step="0.05" value="0.8">
        </div>

        <div class="repeat-feature">
            <div class="repeat-label" style="color:#aaa; font-size:0.9rem;">
                üîÅ Loop Counter (e.g. 108)
            </div>
            <div class="repeat-controls">
                <input type="number" id="repeatCountInput" class="repeat-input" value="108" min="1">
                <button id="btnToggleRepeat" class="repeat-toggle">OFF</button>
            </div>
        </div>
    </main>

    <div class="playlist-section">
        <div class="playlist-header">
            <span>Playlist</span>
            <label for="fileInput" class="file-btn">+ Add MP3</label>
            <input type="file" id="fileInput" accept="audio/mp3, audio/mpeg" multiple style="display:none">
        </div>
        <ul id="playlist" class="playlist"></ul>
    </div>

    <footer>Developed by Rajesh R Mohan</footer>
    <div id="toast">Message</div>

    <script>
        // --- 1. Dynamic Manifest Generation (Embedded in HTML) ---
        const manifest = {
            "name": "Mantra Player",
            "short_name": "Mantra",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#1a1a2e",
            "theme_color": "#1a1a2e",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "https://picsum.photos/seed/mantraIcon192/192/192",
                    "sizes": "192x192",
                    "type": "image/jpeg"
                },
                {
                    "src": "https://picsum.photos/seed/mantraIcon512/512/512",
                    "sizes": "512x512",
                    "type": "image/jpeg"
                }
            ]
        };
        
        const stringManifest = JSON.stringify(manifest);
        const blobManifest = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blobManifest);
        document.getElementById('dynamic-manifest').setAttribute('href', manifestURL);


        // --- 2. Service Worker Generation (Embedded in HTML) ---
        const swCode = `
            const CACHE_NAME = 'mantra-player-v1';
            self.addEventListener('install', (e) => {
                e.waitUntil(
                    caches.open(CACHE_NAME).then((cache) => {
                        return cache.addAll(['./', location.href]);
                    })
                );
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(
                    caches.match(e.request).then((response) => {
                        return response || fetch(e.request);
                    })
                );
            });
        `;

        const blobSW = new Blob([swCode], {type: 'text/javascript'});
        const swURL = URL.createObjectURL(blobSW);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swURL)
                .then(reg => console.log('SW Registered'))
                .catch(err => {
                    console.warn('SW Registration Failed (Likely due to single-file security restrictions):', err);
                    // We do not alert user here as app still works without SW
                });
        }

        // --- 3. PWA Install Prompt Logic ---
        const state = {
            playlist: [],
            currentIndex: -1,
            isPlaying: false,
            audio: new Audio(),
            customRepeatCount: 0,
            isCustomRepeatActive: false,
            deferredPrompt: null
        };

        const els = {
            playPauseBtn: document.getElementById('btnPlayPause'),
            iconPlay: document.getElementById('iconPlay'),
            iconPause: document.getElementById('iconPause'),
            prevBtn: document.getElementById('btnPrev'),
            nextBtn: document.getElementById('btnNext'),
            progressBar: document.getElementById('progressBar'),
            currentTime: document.getElementById('currentTime'),
            duration: document.getElementById('duration'),
            volumeBar: document.getElementById('volumeBar'),
            trackTitle: document.getElementById('currentTitle'),
            trackStatus: document.getElementById('trackStatus'),
            playlist: document.getElementById('playlist'),
            fileInput: document.getElementById('fileInput'),
            toast: document.getElementById('toast'),
            canvas: document.getElementById('visualizer'),
            repeatInput: document.getElementById('repeatCountInput'),
            repeatToggleBtn: document.getElementById('btnToggleRepeat'),
            installBtn: document.getElementById('installBtn'),
            installContainer: document.getElementById('installContainer')
        };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            state.deferredPrompt = e;
            els.installContainer.style.display = 'block';
        });

        els.installBtn.addEventListener('click', async () => {
            if (state.deferredPrompt) {
                state.deferredPrompt.prompt();
                const { outcome } = await state.deferredPrompt.userChoice;
                state.deferredPrompt = null;
                els.installContainer.style.display = 'none';
                if(outcome === 'accepted') showToast("Installing App...");
            }
        });

        // --- 4. Player Logic ---
        let audioCtx, analyser, source, canvasCtx;

        els.fileInput.addEventListener('change', handleFiles);
        els.playPauseBtn.addEventListener('click', togglePlay);
        els.prevBtn.addEventListener('click', playPrev);
        els.nextBtn.addEventListener('click', playNext);
        els.progressBar.addEventListener('input', seekAudio);
        els.volumeBar.addEventListener('input', changeVolume);
        els.repeatToggleBtn.addEventListener('click', toggleCustomRepeat);

        state.audio.addEventListener('timeupdate', updateProgress);
        state.audio.addEventListener('ended', handleTrackEnd);
        state.audio.addEventListener('loadedmetadata', () => {
            els.duration.textContent = formatTime(state.audio.duration);
            els.progressBar.max = state.audio.duration;
        });
        state.audio.addEventListener('play', () => {
            state.isPlaying = true;
            updatePlayPauseIcon();
            initAudioContext();
        });
        state.audio.addEventListener('pause', () => {
            state.isPlaying = false;
            updatePlayPauseIcon();
        });

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            let addedCount = 0;
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                state.playlist.push({ name: file.name.replace(/\.[^/.]+$/, ""), url: url, file: file });
                addedCount++;
            });

            renderPlaylist();
            showToast(`Added ${addedCount} files`);
            
            if (state.currentIndex === -1 && state.playlist.length > 0) {
                loadTrack(0);
                playTrack();
            }
        }

        function loadTrack(index) {
            if (index < 0 || index >= state.playlist.length) return;
            state.currentIndex = index;
            const track = state.playlist[index];
            state.audio.src = track.url;
            state.audio.load();
            
            els.trackTitle.textContent = track.name;
            els.progressBar.value = 0;
            els.currentTime.textContent = "0:00";
            
            if (state.isCustomRepeatActive) {
                state.customRepeatCount = parseInt(els.repeatInput.value) || 108;
                els.trackStatus.textContent = `Repeats left: ${state.customRepeatCount}`;
            } else {
                els.trackStatus.textContent = "Ready to play";
            }
            highlightCurrentTrack();
        }

        function playTrack() {
            if (state.currentIndex === -1 && state.playlist.length > 0) { loadTrack(0); }
            state.audio.play().catch(e => console.error(e));
        }

        function togglePlay() {
            if (state.playlist.length === 0) return;
            if (state.audio.paused) { playTrack(); } else { state.audio.pause(); }
        }

        function playNext() {
            if (state.playlist.length === 0) return;
            let nextIndex = state.currentIndex + 1;
            if (nextIndex >= state.playlist.length) nextIndex = 0;
            loadTrack(nextIndex);
            playTrack();
        }

        function playPrev() {
            if (state.playlist.length === 0) return;
            let prevIndex = state.currentIndex - 1;
            if (prevIndex < 0) prevIndex = state.playlist.length - 1;
            loadTrack(prevIndex);
            playTrack();
        }

        function handleTrackEnd() {
            if (state.isCustomRepeatActive) {
                if (state.customRepeatCount > 0) {
                    state.customRepeatCount--;
                    els.trackStatus.textContent = `Repeats left: ${state.customRepeatCount}`;
                    state.audio.currentTime = 0;
                    state.audio.play();
                    showToast(`Repeating... (${state.customRepeatCount} left)`);
                    return;
                } else {
                    showToast("Custom Loop Finished");
                    playNext();
                    return;
                }
            }
            playNext(); 
        }

        function toggleCustomRepeat() {
            state.isCustomRepeatActive = !state.isCustomRepeatActive;
            if (state.isCustomRepeatActive) {
                els.repeatToggleBtn.textContent = "ON";
                els.repeatToggleBtn.classList.add('active');
                const count = parseInt(els.repeatInput.value) || 108;
                state.customRepeatCount = count;
                if (state.currentIndex !== -1) els.trackStatus.textContent = `Repeats left: ${state.customRepeatCount}`;
                showToast(`Loop Set: ${count} times`);
            } else {
                els.repeatToggleBtn.textContent = "OFF";
                els.repeatToggleBtn.classList.remove('active');
                els.trackStatus.textContent = "Loop Off";
                showToast("Loop Disabled");
            }
        }

        function updateProgress() {
            if (!state.audio.duration) return;
            const cur = state.audio.currentTime;
            els.progressBar.value = cur;
            els.currentTime.textContent = formatTime(cur);
            if(state.isPlaying) drawVisualizer();
        }

        function seekAudio() { state.audio.currentTime = els.progressBar.value; }
        function changeVolume() { state.audio.volume = els.volumeBar.value; }

        function updatePlayPauseIcon() {
            els.iconPlay.style.display = state.isPlaying ? 'none' : 'block';
            els.iconPause.style.display = state.isPlaying ? 'block' : 'none';
        }

        function renderPlaylist() {
            els.playlist.innerHTML = '';
            state.playlist.forEach((track, index) => {
                const li = document.createElement('li');
                li.className = `track-item ${index === state.currentIndex ? 'active' : ''}`;
                li.innerHTML = `<span class="track-item-name">${index + 1}. ${track.name}</span><button class="remove-track" onclick="removeTrack(${index}, event)">√ó</button>`;
                li.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-track')) return;
                    loadTrack(index);
                    playTrack();
                });
                els.playlist.appendChild(li);
            });
        }

        function highlightCurrentTrack() {
            const items = els.playlist.querySelectorAll('.track-item');
            items.forEach((item, idx) => {
                if (idx === state.currentIndex) item.classList.add('active');
                else item.classList.remove('active');
            });
        }

        window.removeTrack = function(index, event) {
            event.stopPropagation();
            URL.revokeObjectURL(state.playlist[index].url);
            if (index === state.currentIndex) {
                state.audio.pause();
                state.isPlaying = false;
                updatePlayPauseIcon();
                state.currentIndex = -1;
                els.trackTitle.textContent = "No Track Selected";
            } else if (index < state.currentIndex) { state.currentIndex--; }
            state.playlist.splice(index, 1);
            renderPlaylist();
        };

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 3000);
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' + sec : sec}`;
        }

        // --- Visualizer ---
        function initAudioContext() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                source = audioCtx.createMediaElementSource(state.audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                analyser.fftSize = 64;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                canvasCtx = els.canvas.getContext('2d');
                els.canvas.width = els.canvas.offsetWidth;
                els.canvas.height = els.canvas.offsetHeight;
                window.visualizerData = { dataArray, bufferLength };
            } catch (e) { console.warn("Audio Context setup failed"); }
        }

        function drawVisualizer() {
            if (!window.visualizerData || !state.isPlaying) return;
            const { dataArray, bufferLength } = window.visualizerData;
            analyser.getByteFrequencyData(dataArray);
            const width = els.canvas.width;
            const height = els.canvas.height;
            const barWidth = (width / bufferLength) * 2.5;
            let x = 0;
            canvasCtx.clearRect(0, 0, width, height);
            const gradient = canvasCtx.createLinearGradient(0, height, 0, 0);
            gradient.addColorStop(0, '#ff0055');
            gradient.addColorStop(1, '#ff99bb');
            canvasCtx.fillStyle = gradient;
            for(let i = 0; i < bufferLength; i++) {
                let barHeight = dataArray[i] / 255 * height;
                canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                x += barWidth + 2;
            }
            requestAnimationFrame(drawVisualizer);
        }
    </script>
</body>
</html>